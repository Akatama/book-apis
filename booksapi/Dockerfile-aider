# syntax=docker/dockerfile:1.7

############################
# Base image
############################
FROM python:3.13-slim AS base

ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1

WORKDIR /app

# Common OS deps
RUN apt-get update && apt-get install -y --no-install-recommends \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

############################
# Builder image
############################
FROM base AS builder

ENV UV_SYSTEM_PYTHON=1 \
    UV_LINK_MODE=copy

# Extra build-time deps
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

# Copy uv from the official image
COPY --from=ghcr.io/astral-sh/uv:0.9.11 /uv /bin/uv

# Copy project metadata first for better caching
COPY pyproject.toml uv.lock ./

# Create a virtualenv and install dependencies into it
RUN uv venv /app/.venv

# Use the venv by default in subsequent builder steps
ENV PATH="/app/.venv/bin:${PATH}"

# Install dependencies (without installing the project itself yet)
RUN uv sync --frozen --no-install-project

# Now copy the application code
COPY . .

# Install the project itself into the venv
RUN uv sync --frozen

############################
# Runtime image
############################
FROM base AS runtime

# Create non-root user and group
RUN groupadd --system appuser && useradd --system --gid appuser --home-dir /app appuser

# Copy the virtualenv and app code from builder, setting ownership directly
COPY --from=builder --chown=appuser:appuser /app/.venv /app/.venv
COPY --from=builder --chown=appuser:appuser /app /app

ENV PATH="/app/.venv/bin:${PATH}"

USER appuser

# Default command: run the FastAPI app using fastapi's CLI
CMD ["fastapi", "run", "main.py"]
